<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ñ—É—Ä–Ω–∞–ª –∞—Ç–∞–∫</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #f9f9f9; }
     .attack-tags span { background: #e74c3c !important; color: white; padding: 2px 6px; border-radius: 3px; margin-right: 4px; font-size: 0.9em; } 

    .pagination { margin-top: 20px; }
    .pagination button, select { padding: 6px 12px; margin-right: 6px; font-size: 1em; }

    .mitm-btn {
      background-color: #2ecc71;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      text-decoration: none;
    }
    .mitm-btn:hover {
      background-color: #27ae60;
    }

    .response-btn {
      padding: 4px 10px;
      background-color: #007bff;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 0.9em;
    }
    .response-btn:hover {
      background-color: #0056b3;
    }

    #responseModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
    }
    #responseModalContent {
      background: white;
      max-width: 90%;
      max-height: 80%;
      margin: 5% auto;
      padding: 20px;
      overflow: auto;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    #responseModalClose {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2em;
    }
    .attack-xss {
      background: #f39c12; /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
      color: white;
    }
    .attack-sqli, .attack-cmdi {
      background: #c0392b; /* —Ç—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π */
      color: white;
    }
    .attack-info {
      background: #3498db; /* —Å–∏–Ω–∏–π */
      color: white;
    }
    .attack-csrf {
      background: #9b59b6; /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
      color: white;
    }
    .attack-lfi, .attack-rfi {
      background: #e67e22; /* –º–æ—Ä–∫–æ–≤–Ω—ã–π */
      color: white;
    }

    #recommendationModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
    }
    #recommendationModalContent {
      background: white;
      max-width: 500px;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
    }
    #recommendationModalClose {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2em;
    }
    #recommendationModalList {
      margin-top: 20px;
    }

  </style>

  <script>
    const wsProtocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
    const ws = new WebSocket(wsProtocol + location.host + "/ws/logs");
    ws.onmessage = () => location.reload();

    function changePerPage(select) {
      const params = new URLSearchParams(window.location.search);
      params.set('per_page', select.value);
      params.set('page', '1');
      window.location.search = params.toString();
    }

    function goToPage(page) {
      const params = new URLSearchParams(window.location.search);
      params.set('page', page.toString());
      window.location.search = params.toString();
    }

    function tryParseNestedJSON(obj) {
      if (typeof obj === "string") {
        try {
          const parsed = JSON.parse(obj);
          return tryParseNestedJSON(parsed);
        } catch {
          return obj;
        }
      } else if (Array.isArray(obj)) {
        return obj.map(tryParseNestedJSON);
      } else if (typeof obj === "object" && obj !== null) {
        const result = {};
        for (const key in obj) {
          result[key] = tryParseNestedJSON(obj[key]);
        }
        return result;
      }
      return obj;
    }

    document.addEventListener("DOMContentLoaded", function() {
      const modal = document.getElementById("responseModal");
      const modalText = document.getElementById("responseModalText");
      const modalClose = document.getElementById("responseModalClose");

      document.querySelectorAll(".response-btn").forEach(button => {
        button.addEventListener("click", () => {
          let respAttr = button.getAttribute("data-response");
          try {
            let resp = JSON.parse(respAttr);
            let smartParsed = tryParseNestedJSON(resp);
            modalText.textContent = JSON.stringify(smartParsed, null, 2);
          } catch (e) {
            modalText.textContent = respAttr;
          }
          modal.style.display = "block";
        });
      });

      modalClose.onclick = () => {
        modal.style.display = "none";
        modalText.textContent = "";
      };

      window.onclick = event => {
        if (event.target === modal) {
          modal.style.display = "none";
          modalText.textContent = "";
        }
      };

      const recommendationModal = document.getElementById("recommendationModal");
      const recommendationList = document.getElementById("recommendationModalList");
      const recommendationClose = document.getElementById("recommendationModalClose");

      document.querySelectorAll(".recommendation-btn").forEach(button => {
        button.addEventListener("click", () => {
          recommendationList.innerHTML = "";
          try {
            const recs = JSON.parse(button.getAttribute("data-recommendations"));
            recs.forEach(rec => {
              const li = document.createElement("li");
              li.textContent = "üîí " + rec;
              recommendationList.appendChild(li);
            });
          } catch (e) {
            const li = document.createElement("li");
            li.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.";
            recommendationList.appendChild(li);
          }
          recommendationModal.style.display = "block";
        });
      });

      recommendationClose.onclick = () => {
        recommendationModal.style.display = "none";
        recommendationList.innerHTML = "";
      };

      window.addEventListener("click", event => {
        if (event.target === recommendationModal) {
          recommendationModal.style.display = "none";
          recommendationList.innerHTML = "";
        }
      });
    });


  </script>
</head>

<body>
  <h1>–ñ—É—Ä–Ω–∞–ª –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</h1>

  <label for="per_page_select">–ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
  <select id="per_page_select" onchange="changePerPage(this)">
    {% for option in [5, 10, 20, 50, 100] %}
      <option value="{{ option }}" {% if option == per_page %}selected{% endif %}>{{ option }}</option>
    {% endfor %}
  </select>

  <table>
    <thead>
      <tr>
        <th>–í—Ä–µ–º—è</th>
        <th>IP –∫–ª–∏–µ–Ω—Ç–∞</th>
        <th>–ú–µ—Ç–æ–¥</th>
        <th>URL</th>
        <th>–ê—Ç–∞–∫–∏</th>
        <th>–§—Ä–∞–≥–º–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∞</th>
        <th>–§—Ä–∞–≥–º–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞</th>
        <th>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</th>
        <th>mitmweb</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td>{{ log.timestamp }}</td>
        <td>{{ log.source_ip }}</td>
        <td>{{ log.method }}</td>
        <td><a href="{{ log.url }}" target="_blank">{{ log.url }}</a></td>
        {% set attack_class_map = {
          'SQL Injection': 'sql-injection',
          'SQLi': 'sql-injection',
          'Command Injection': 'cmdi',
          'CMDi': 'cmdi',
          'Cross-Site Scripting': 'xss',
          'XSS': 'xss',
          'CSRF': 'csrf',
          'LFI': 'lfi',
          'RFI': 'rfi',
          'Info Leak': 'info',
          'Information Disclosure': 'info'
        } %}
        <td class="attack-tags">
          {% for attack in log.detected_attacks %}
            <span class="attack-{{ attack_class_map.get(attack, attack|lower|replace(' ', '-')) }}">{{ attack }}</span>
          {% endfor %}
        </td>
        <td><pre>{{ log.request_snippet }}</pre></td>
        <td>
          {% if log.response_snippet and log.response_snippet|length > 15 %}
            <button class="response-btn" data-response='{{ log.response_snippet | tojson | safe }}'>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
          {% else %}
            <pre>{{ log.response_snippet }}</pre>
          {% endif %}
        </td>
        <td>
          <button class="recommendation-btn" data-recommendations='{{ log.recommendations | tojson | safe }}'>
            –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          </button>
        </td>
        <td>
          <a class="mitm-btn"
             href="http://95.181.173.47:8081/#/flows/{{log.flow_id}}/request"
             target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="9" style="text-align:center;">–õ–æ–≥–æ–≤ –Ω–µ—Ç</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="pagination">
    <button onclick="goToPage(1)" {% if page <= 1 %}disabled{% endif %}>¬´ –ü–µ—Ä–≤–∞—è</button>
    <button onclick="goToPage({{ page - 1 if page > 1 else 1 }})" {% if page <= 1 %}disabled{% endif %}>‚Äπ –ù–∞–∑–∞–¥</button>
    <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ total_pages }}</span>
    <button onclick="goToPage({{ page + 1 if page < total_pages else total_pages }})" {% if page >= total_pages %}disabled{% endif %}>–í–ø–µ—Ä—ë–¥ ‚Ä∫</button>
    <button onclick="goToPage({{ total_pages }})" {% if page >= total_pages %}disabled{% endif %}>–ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª</button>
  </div>

  <div id="responseModal">
    <div id="responseModalContent">
      <span id="responseModalClose">&times;</span>
      <pre id="responseModalText"></pre>
    </div>
  </div>
  <div id="recommendationModal">
  <div id="recommendationModalContent">
    <span id="recommendationModalClose">&times;</span>
    <ul id="recommendationModalList"></ul>
  </div>
</div>

</body>
</html>
